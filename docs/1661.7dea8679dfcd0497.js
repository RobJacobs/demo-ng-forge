"use strict";(self.webpackChunkdemo_ng_forge=self.webpackChunkdemo_ng_forge||[]).push([[1661],{30248:(K,D,h)=>{h.d(D,{Z:()=>R});var M=h(53661);class R{constructor(l){this.size=0,this._start=0,this.maxSize=l,this._buffer=new Array(l)}get entries(){return this._buffer}enqueue(l){if(this.size===this.maxSize){const r=this._buffer[this._start];return this._buffer[this._start]=l,this._start=(this._start+1)%this.maxSize,r}return this._buffer[(this._start+this.size++)%this.maxSize]=l,null}dequeue(){if(0===this.size)return null;const l=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,l}peek(){return 0===this.size?null:this._buffer[this._start]}find(l){if(0===this.size)return null;for(const r of this._buffer)if((0,M.pC)(r)&&l(r))return r;return null}clear(l){let r=this.dequeue();for(;(0,M.pC)(r);)l&&l(r),r=this.dequeue()}}},99704:(K,D,h)=>{h.d(D,{T:()=>y});var M=h(71670),R=h(30801),S=h(20834),l=h(28679),r=h(53971),E=h(53661),i=h(55798),_=h(82769),a=h(1611),g=h(52300),b=h(70260),P=h(51399),O=h(86626);function I(m,d){const s=d.length;if(m<d[0].value||1===s)return d[0].size;for(let o=1;o<s;o++)if(m<d[o].value)return d[o-1].size+(m-d[o-1].value)/(d[o].value-d[o-1].value)*(d[o].size-d[o-1].size);return d[s-1].size}class W{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=b.v}getSizeVVFieldStops(d){const s=this._vvSizeFieldStops;if(s)switch(s.type){case"static":return s;case"level-dependent":return(0,E.Pt)(s.levels[d],()=>{let o=1/0,c=0;for(const T in s.levels){const U=parseFloat(T),V=Math.abs(d-U);V<o&&(o=V,c=U)}if(o===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const p=2**((d-c)/2),x=(0,E.Wg)(s.levels[c]),w=new Float32Array(x.values);return w[2]*=p,w[3]*=p,{sizes:(0,E.Wg)(x.sizes),values:w}});default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(d){(0,E.pC)(this._vvInfo)&&this._updateVisualVariables(this._vvInfo.vvRanges,d)}setInfo(d,s,o){this._updateEffects(o),this._vvInfo=s,this._technique=(0,P.EJ)(d),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,d)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:(0,O.hc)("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(d){this.outsideLabelsVisible=!!(0,E.pC)(d)&&d.excludedLabelsVisible}_updateVisualVariables(d,s){const o=this._vvMaterialParameters;if(o.vvOpacityEnabled=!1,o.vvSizeEnabled=!1,o.vvColorEnabled=!1,o.vvRotationEnabled=!1,!d)return;const c=d.size;if(c){if(o.vvSizeEnabled=!0,c.minMaxValue){const T=c.minMaxValue;let U,V;if((0,g.$K)(T.minSize)&&(0,g.$K)(T.maxSize))if((0,g.hj)(T.minSize)&&(0,g.hj)(T.maxSize))U=(0,i.F2)(T.minSize),V=(0,i.F2)(T.maxSize);else{const j=s.scale;U=(0,i.F2)(I(j,T.minSize.stops)),V=(0,i.F2)(I(j,T.maxSize.stops))}this.vvSizeMinMaxValue.set([T.minDataValue,T.maxDataValue,U,V])}if(c.scaleStops&&(this.vvSizeScaleStopsValue=(0,i.F2)(I(s.scale,c.scaleStops.stops))),c.unitValue){const T=(0,_.c9)(s.spatialReference)/a.a[c.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=T/s.resolution}c.fieldStops&&(this._vvSizeFieldStops=c.fieldStops)}const p=d.color;p&&(o.vvColorEnabled=!0,this.vvColorValues.set(p.values),this.vvColors.set(p.colors));const x=d.opacity;x&&(o.vvOpacityEnabled=!0,this.vvOpacityValues.set(x.values),this.vvOpacities.set(x.opacities));const w=d.rotation;w&&(o.vvRotationEnabled=!0,o.vvRotationType=w.type)}}class y extends r.Z{constructor(d){super(d),this._rendererInfo=new W,this._materialItemsRequestQueue=new S.Z,this.attributeView=new l.H(()=>this.onAttributeStoreUpdate())}destroy(){this.children.forEach(d=>d.destroy()),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(d,s,o){this._rendererInfo.setInfo(d,s,o),this.requestRender()}getMaterialItems(d,s){var o=this;return(0,M.Z)(function*(){if(!d||0===d.length)return[];const c=(0,R.hh)();return o._materialItemsRequestQueue.push({items:d,abortOptions:s,resolver:c}),o.requestRender(),c.promise})()}doRender(d){if(d.context.capabilities.enable("textureFloat"),d.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let s=this._materialItemsRequestQueue.pop();for(;s;)this._processMaterialItemRequest(d,s),s=this._materialItemsRequestQueue.pop()}super.doRender(d)}renderChildren(d){for(const s of this.children)s.commit(d);this._rendererInfo.update(d.state),super.renderChildren(d)}updateTransforms(d){if(this.children.some(s=>s.hasData))for(const s of this.children)s.setTransform(d)}createRenderParams(d){const s=super.createRenderParams(d);return s.rendererInfo=this._rendererInfo,s.attributeView=this.attributeView,s}onAttributeStoreUpdate(){}_processMaterialItemRequest(d,{items:s,abortOptions:o,resolver:c}){const{painter:p,pixelRatio:x}=d,w=s.map(T=>p.textureManager.rasterizeItem(T.symbol,x,T.glyphIds,o));Promise.all(w).then(T=>{if(!this.stage)return void c.reject();const U=T.map((V,j)=>({id:s[j].id,mosaicItem:V}));c.resolve(U)},c.reject)}}},28679:(K,D,h)=>{h.d(D,{H:()=>m});var M=h(71670),R=h(32995),S=h(67087),l=h(28191),r=h(53661),E=h(30801),i=h(80696),_=h(21288),a=h(52300),g=h(13458),b=h(69923),P=h(2512),O=h(74697);const I=l.Z.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),W=(0,g.g)(g.J,I);class y{constructor(s,o,c){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:p,pixelType:x,textureOnly:w}=s,T=(0,a.UK)(x);this.shared=c,this.pixelType=x,this.size=o,this.textureOnly=w,w||(this.data=new T((0,r.Wg)(p))),this._resetRange()}destroy(){(0,r.yw)(this._texture,s=>s.dispose());for(const s in this._fbos)(0,r.yw)(this._fbos[s],o=>{"0"===s&&o.detachColorTexture(),o.dispose()}),this._fbos[s]=null;this._texture=null}get _textureDesc(){return{target:b.No.TEXTURE_2D,wrapMode:b.e8.CLAMP_TO_EDGE,pixelFormat:b.VI.RGBA,dataType:this.pixelType,samplingMode:b.cw.NEAREST,width:this.size,height:this.size}}setData(s,o,c){const p=(0,_.jL)(s),x=(0,r.Wg)(this.data),w=p*this.texelSize+o;!x||w>=x.length||(x[w]=c,this.dirtyStart=Math.min(this.dirtyStart,p),this.dirtyEnd=Math.max(this.dirtyEnd,p))}getData(s,o){if((0,r.Wi)(this.data))return null;const c=(0,_.jL)(s)*this.texelSize+o;return!this.data||c>=this.data.length?null:this.data[c]}getTexture(s){return(0,r.Pt)(this._texture,()=>this._initTexture(s))}getFBO(s,o=0){if((0,r.Wi)(this._fbos[o])){const c={colorTarget:b.Lm.TEXTURE,depthStencilTarget:b.OU.NONE},p=0===o?this.getTexture(s):this._textureDesc;this._fbos[o]=new P.X(s,c,p)}return this._fbos[o]}get locked(){return!(this.pixelType!==b.Br.UNSIGNED_BYTE||!this.shared||this.textureOnly||!(0,S.Z)("esri-atomics")||!this.data)&&1===Atomics.load(this.data,0)}get hasDirty(){return this.dirtyEnd>=this.dirtyStart}updateTexture(s,o){if(!this.locked){try{const c=this.dirtyStart,p=this.dirtyEnd;if(!this.hasDirty)return;this._resetRange();const x=(0,r.Wg)(this.data).buffer,w=this.getTexture(s),T=4,U=(c-c%this.size)/this.size,j=U,Y=(p-p%this.size)/this.size,G=U*this.size*T,$=(this.size+Y*this.size)*T-G,H=(0,a.UK)(this.pixelType),J=new H(x,G*H.BYTES_PER_ELEMENT,$),q=this.size,Q=Y-j+1;if(Q>this.size)return void I.error(new R.Z("mapview-webgl","Out-of-bounds index when updating AttributeData"));w.updateData(0,0,j,q,Q,J)}catch{}o()}}update(s){const{data:o,start:c,end:p}=s;if((0,r.pC)(o)&&(0,r.pC)(this.data)){const x=this.data,w=c*this.texelSize;for(let T=0;T<o.length;T++)s.layout&1<<T%this.texelSize&&(x[w+T]=o[T])}this.dirtyStart=Math.min(this.dirtyStart,c),this.dirtyEnd=Math.max(this.dirtyEnd,p)}resize(s,o){const c=this.size;if(this.size=o,this.textureOnly)return void(c!==this.size&&(this._lastTexture=this._texture,this._texture=null));const p=(0,a.UK)(this.pixelType);this.destroy(),this.data=new p((0,r.Wg)(s.buffer))}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(s){const o=new O.x(s,this._textureDesc,(0,r.Pt)(this.data,void 0));if((0,r.pC)(this._lastTexture)&&this._fbos[0]){const c=this._lastTexture.descriptor.width,p=this._lastTexture.descriptor.height,x=this._lastTexture.descriptor.dataType,w=this._lastTexture.descriptor.pixelFormat,T=this.getFBO(s),U=(0,a.Yw)(x),V=new((0,a.UK)(x))(new ArrayBuffer(c*p*U*this.texelSize)),j=s.getBoundFramebufferObject(),{x:X,y:Y,width:G,height:$}=s.getViewport();s.bindFramebuffer(T),T.readPixels(0,0,c,p,w,x,V),o.updateData(0,0,0,2*c,p/2,V),s.setViewport(X,Y,G,$),s.bindFramebuffer(j)}return this.destroy(),this._texture=o,this._texture}}class m{constructor(s){this._onUpdate=s,this._initialized=!1,this._forceNextUpload=!1,this._locked=!1}initialize(s){const{blocks:o,shared:c,size:p}=s;if(this.shared=c,this.size=p,W("Initializing AttributeStoreView",s),(0,r.Wi)(this._data))this._data=(0,r.Fd)(o,x=>new y(x,p,c));else for(let x=0;x<this._data.length;x++){const w=this._data[x],T=o[x];(0,r.pC)(T)&&((0,r.Wi)(w)?this._data[x]=new y(T,p,c):w.resize(T,p))}this._initialized=!0}destroy(){(0,r.yw)(this._data,s=>(0,r.Fd)(s,o=>o.destroy())),(0,r.yw)(this._defaultTexture,s=>s.dispose())}isEmpty(){return(0,r.Wi)(this._data)}isUpdating(){const s=(0,r.pC)(this._pendingAttributeUpdate),o=s;return(0,S.Z)("esri-2d-log-updating")&&console.log(`Updating AttributeStoreView ${o}\n  -> hasPendingUpdate ${s}`),o}getBlock(s){return(0,r.Wi)(this._data)?null:this._data[s]}setLabelMinZoom(s,o){this.setData(s,0,1,o)}getLabelMinZoom(s){return this.getData(s,0,1,255)}getFilterFlags(s){return this.getData(s,0,0,0)}getVVSize(s){return this.getData(s,i.aK,0,0)}getData(s,o,c,p){if(!this._data)return 0;const x=(0,r.Wg)(this._data)[o];if((0,r.Wi)(x))return 0;const w=x.getData(s,c);return(0,r.pC)(w)?w:p}setData(s,o,c,p){const x=(0,r.Wg)(this._data)[o];(0,r.Wg)(x).setData(s,c,p)}lockTextureUpload(){this._locked=!0}unlockTextureUpload(){this._locked=!1}forceTextureUpload(){this._forceNextUpload=!0}requestUpdate(s){var o=this;return(0,M.Z)(function*(){if(o._pendingAttributeUpdate)return void I.error(new R.Z("mapview-webgl","Tried to update attribute data with a pending update"));const c=(0,E.hh)();return W("AttributeStoreView Update Requested",s),o._pendingAttributeUpdate={data:s,resolver:c},o._onUpdate(),c.promise})()}update(){if(this._initialized&&(0,r.pC)(this._pendingAttributeUpdate)){(0,S.Z)("esri-2d-update-debug")&&console.debug("AttributeStoreView::update");const{data:s,resolver:o}=this._pendingAttributeUpdate,c=(0,r.Wg)(this._data);for(let p=0;p<s.blocks.length;p++){const x=s.blocks[p];(0,r.yw)(c[p],T=>(0,r.yw)(x,U=>{W(`Updating block ${p}`,U),T.update(U)}))}this._pendingAttributeUpdate=null,o(),this._onUpdate()}}bindTextures(s,o=!0){const c=this._getDefaultTexture(s);if(!this._initialized)return s.bindTexture(c,i.iJ),void(o&&(s.bindTexture(c,i.nM),s.bindTexture(c,i.Ij),s.bindTexture(c,i.f2),s.bindTexture(c,i.By),s.bindTexture(c,i.mx),s.bindTexture(c,i.Xj)));const p=(0,r.Wg)(this._data);this._locked&&!this._forceNextUpload||((0,r.JR)(p,x=>x.updateTexture(s,()=>this._onUpdate())),this._forceNextUpload=!1),s.bindTexture((0,r.R2)(p[i._5],c,x=>x.getTexture(s)),i.iJ),o&&(s.bindTexture((0,r.R2)(p[i.pU],c,x=>x.getTexture(s)),i.Xj),s.bindTexture((0,r.R2)(p[i.xl],c,x=>x.getTexture(s)),i.nM),s.bindTexture((0,r.R2)(p[i.aK],c,x=>x.getTexture(s)),i.Ij),s.bindTexture((0,r.R2)(p[i.lK],c,x=>x.getTexture(s)),i.f2),s.bindTexture((0,r.R2)(p[i.By],c,x=>x.getTexture(s)),i.By),s.bindTexture((0,r.R2)(p[i.mx],c,x=>x.getTexture(s)),i.mx))}_getDefaultTexture(s){return(0,r.Wi)(this._defaultTexture)&&(this._defaultTexture=new O.x(s,{wrapMode:b.e8.CLAMP_TO_EDGE,pixelFormat:b.VI.RGBA,dataType:b.Br.UNSIGNED_BYTE,samplingMode:b.cw.NEAREST,width:1,height:1},new Uint8Array(4))),this._defaultTexture}}},20533:(K,D,h)=>{h.d(D,{Q:()=>i,g:()=>r});var M=h(67087),R=h(53661),S=h(91957);const l=(0,M.Z)("esri-2d-log-allocations");class r{constructor(a,g){this._array=a,this._pool=g}get array(){return this._array}get length(){return this._array.length}static create(a,g){const b=g.acquire(a);return new r(b,g)}expand(a){const g=this._pool.acquire(a);g.set(this._array),this._pool.release(this._array),this._array=g}destroy(){this._pool.release(this._array)}set(a,g){this._array.set(a._array,g)}slice(){const a=this._pool.acquire(this._array.byteLength);return a.set(this._array),new r(a,this._pool)}}class E{constructor(){this._data=new ArrayBuffer(E.BYTE_LENGTH),this._freeList=new S.m({start:0,end:this._data.byteLength})}static get BYTE_LENGTH(){return 64e6}get buffer(){return this._data}allocate(a){const g=this._freeList.firstFit(a);return(0,R.Wi)(g)?null:new Uint32Array(this._data,g,a/Uint32Array.BYTES_PER_ELEMENT)}free(a){this._freeList.free(a.byteOffset,a.byteLength)}}class i{constructor(){this._bytesAllocated=0,this._pages=[],this._pagesByBuffer=new Map,this._addPage()}destroy(){this._pages=[],this._pagesByBuffer=null}get _bytesTotal(){return this._pages.length*E.BYTE_LENGTH}acquire(a){if(this._bytesAllocated+=a,l&&console.log(`Allocating ${a}, (${this._bytesAllocated} / ${this._bytesTotal})`),a>E.BYTE_LENGTH)return new Uint32Array(a/Uint32Array.BYTES_PER_ELEMENT);for(const g of this._pages){const b=g.allocate(a);if((0,R.pC)(b))return b}return(0,R.s3)(this._addPage().allocate(a),"Expected to allocate page")}release(a){this._bytesAllocated-=a.byteLength,l&&console.log(`Freeing ${a.byteLength}, (${this._bytesAllocated} / ${this._bytesTotal})`);const g=this._pagesByBuffer.get(a.buffer);g&&g.free(a)}_addPage(){const a=new E;return this._pages.push(a),this._pagesByBuffer.set(a.buffer,a),a}}},21288:(K,D,h)=>{h.d(D,{KS:()=>a,PX:()=>r,QS:()=>b,_I:()=>M,jL:()=>_,nE:()=>g,vs:()=>i,xp:()=>E});const M=8388607,R=8388608,r=0,E=1,i=P=>(P&R)>>>23,_=P=>P&M,a=P=>i(P)===E?254:255;function g(P){return i(P)===E}function b(P,O){return((O?R:0)|P)>>>0}},53971:(K,D,h)=>{h.d(D,{Z:()=>i});var M=h(67087),R=h(20753),S=h(83345),l=h(26877),r=h(67135);const E=(_,a)=>_.key.level-a.key.level!=0?_.key.level-a.key.level:_.key.row-a.key.row!=0?_.key.row-a.key.row:_.key.col-a.key.col;class i extends S.Z{constructor(a){super(),this._tileInfoView=a}get requiresDedicatedFBO(){return!1}renderChildren(a){this.sortChildren(E),this.setStencilReference(a),super.renderChildren(a)}createRenderParams(a){const{state:g}=a,b=super.createRenderParams(a);return b.requiredLevel=this._tileInfoView.getClosestInfoForScale(g.scale).level,b.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(g.scale),b}prepareRenderPasses(a){const g=super.prepareRenderPasses(a);return g.push(a.registerRenderPass({name:"stencil",brushes:[r.Z],drawPhase:R.jx.DEBUG|R.jx.MAP|R.jx.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,M.Z)("esri-tiles-debug")&&g.push(a.registerRenderPass({name:"tileInfo",brushes:[l.Z],drawPhase:R.jx.DEBUG,target:()=>this.children})),g}getStencilTarget(){return this.children}setStencilReference(a){let g=1;for(const b of this.children)b.stencilRef=g++}}},11653:(K,D,h)=>{h.d(D,{I:()=>l});var M=h(38974),R=h(99390),S=h(67026);class l extends R.s{constructor(E,i,_,a,g,b,P=g,O=b){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new S.Z(E),this.resolution=i,this.x=_,this.y=a,this.width=g,this.height=b,this.rangeX=P,this.rangeY=O}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(E){const i=this.resolution/(E.resolution*E.pixelRatio),_=this.transforms.tileMat3,[a,g]=E.toScreenNoRotation([0,0],[this.x,this.y]);(0,M.s)(_,this.width/this.rangeX*i,0,0,0,this.height/this.rangeY*i,0,a,g,1),(0,M.m)(this.transforms.dvs,E.displayViewMat3,_)}}},6833:(K,D,h)=>{h.d(D,{o:()=>_});var M=h(53072),R=h(80309),S=h(38974),l=h(40334),r=h(80696),E=h(11653);class _ extends E.I{constructor(g,b,P,O){super(g,b,P,O,r.I_,r.I_)}destroy(){super.destroy(),this._transforms&&_.TransformCache.release(this.key.hash)}setTransform(g){const b=this.resolution/g.resolution,P=this.transforms.tileMat3,[O,I]=g.toScreenNoRotation([0,0],[this.x,this.y]),W=this.width/this.rangeX*b,y=this.height/this.rangeY*b;(0,S.s)(P,W,0,0,0,y,0,O,I,1),(0,S.m)(this.transforms.dvs,g.displayViewMat3,P);const m=this.transforms.labelMat2d,d=window.devicePixelRatio,s=(0,M.d)((0,R.c)(),W*d,0,0,y*d,O*d,I*d);(0,M.m)(m,g.viewMat2d,s)}_createTransforms(){return _.TransformCache.acquire(this.key.hash)}}_.TransformCache=new class i{acquire(g){return{refCount:1,version:-1,labelMat2d:(0,R.c)(),tileMat3:(0,l.c)(),dvs:(0,l.c)()}}release(g){}}},46461:(K,D,h)=>{h.d(D,{$:()=>l});var M=h(53661),R=h(80696);const S=2147483647;class l{constructor(i){this._head=i,this._cursor=i}static from(i,_=0,a=i.byteLength/r.BYTES_PER_RECORD-_){const g=new r(new Int32Array(i,_*r.BYTES_PER_RECORD,a*r.ELEMENTS_PER_RECORD));return new l(g)}size(){let i=this._cursor,_=0;for(;i;)_+=i.size(),i=i._link;return _}get id(){return this._cursor.id}set id(i){this._cursor.id=i}get materialKey(){return this._cursor.materialKey}set materialKey(i){this._cursor.materialKey=i}get insertAfter(){return this._cursor.insertAfter}get indexFrom(){return this._cursor.indexFrom}set indexFrom(i){this._cursor.indexFrom=i}get indexCount(){return this._cursor.indexCount}set indexCount(i){this._cursor.indexCount=i}get vertexFrom(){return this._cursor.vertexFrom}set vertexFrom(i){this._cursor.vertexFrom=i}get vertexCount(){return this._cursor.vertexCount}set vertexCount(i){this._cursor.vertexCount=i}get sortKey(){return this._cursor.sortKey}set sortKey(i){this._cursor.sortKey=i}get index(){return this._cursor._indexStart+this._cursor._index}seekIndex(i){let _=i;for(this._cursor=this._head;this._cursor;){const a=this._cursor.size();if(_<a)return this._cursor._index=_,!0;_-=a,this._cursor=this._cursor._link}return!1}forEach(i){const _=this.getCursor();for(;_.next();)i(_)}link(i){if(!this._head)return void(this._head=i._head);let _=this._head;for(;_._link;)_=_._link;_._link=i._head,_._link._indexStart=_._indexStart+_.size()}getCursor(){return this.copy()}lookup(i){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(i);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}copy(){const i=new l(this._head?.copy());if(!i._head)return i;let _=i._head,a=i._head._link;for(;a;)_._link=a.copy(),_=a,a=_._link;return i}next(){return!!this._cursor&&(!!this._cursor.next()||!!this._cursor._link&&(this._cursor=this._cursor._link,this.next()))}peekId(){return this._cursor.peekId()??this._cursor._link.peekId()}delete(i){let _=this._head,a=null;for(;_;){if(_.delete(i))return _.isEmpty()&&((0,M.pC)(a)&&(a._link=_._link),_===this._head&&(this._head=_._link),_===this._cursor&&(this._cursor=_._link)),!0;a=_,_=_._link}return!1}}l.ELEMENTS_PER_RECORD=R.XJ,l.BYTES_PER_RECORD=l.ELEMENTS_PER_RECORD*Int32Array.BYTES_PER_ELEMENT;class r{constructor(i){this._link=null,this._index=-1,this._indexStart=0,this._packedRecordsF32=null,this._deletedCount=0,this._offsets={instance:null},this._packedRecords=i}static from(i,_=0,a=i.byteLength/this.BYTES_PER_RECORD-_){return new r(new Int32Array(i,_*this.BYTES_PER_RECORD,a*this.ELEMENTS_PER_RECORD))}delete(i){const _=this._index,a=this.lookup(i);if(a)for(this.id=S,++this._deletedCount;this.next()&&this.id===i;)this.id=S,++this._deletedCount;return this._index=_,a}isEmpty(){return this._deletedCount===this.size()}link(i){this._link?this._link.link(i):this._link=i}lookup(i){if((0,M.Wi)(this._offsets.instance)){this._offsets.instance=new Map;const a=this.copy();a._index=-1;let g=0;for(;a.next();)a.id!==g&&(this._offsets.instance.set(a.id,a._index),g=a.id)}if(!this._offsets.instance.has(i))return!1;const _=this._index;return this._index=this._offsets.instance.get(i),this.id!==S||(this._index=_,!1)}get id(){return this._packedRecords[this._index*r.ELEMENTS_PER_RECORD]}set id(i){this._packedRecords[this._index*r.ELEMENTS_PER_RECORD]=i}get materialKey(){return this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+1]}set materialKey(i){this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+1]=i}get insertAfter(){return this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+2]}get indexFrom(){return this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+3]}set indexFrom(i){this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+3]=i}get indexCount(){return this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+4]}set indexCount(i){this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+4]=i}get vertexFrom(){return this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+5]}set vertexFrom(i){this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+5]=i}get vertexCount(){return this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+6]}set vertexCount(i){this._packedRecords[this._index*r.ELEMENTS_PER_RECORD+6]=i}get sortKey(){return this._packedRecordsF32||(this._packedRecordsF32=new Float32Array(this._packedRecords.buffer)),this._packedRecordsF32[this._index*r.ELEMENTS_PER_RECORD+7]}set sortKey(i){this._packedRecordsF32||(this._packedRecordsF32=new Float32Array(this._packedRecords.buffer)),this._packedRecordsF32[this._index*r.ELEMENTS_PER_RECORD+7]=i}get index(){return this._index}size(){return this._packedRecords.length/r.ELEMENTS_PER_RECORD}next(){for(;++this._index<this.size()&&this.id===S;);return this._index<this.size()}peekId(){const i=(this._index+1)*r.ELEMENTS_PER_RECORD;return i>=this._packedRecords.length?0:this._packedRecords[i]}getCursor(){return this.copy()}copy(){const i=new r(this._packedRecords);return i._indexStart=this._indexStart,i._link=this._link,i._index=this._index,i._offsets=this._offsets,i._deletedCount=this._deletedCount,i}}r.ELEMENTS_PER_RECORD=R.XJ,r.BYTES_PER_RECORD=r.ELEMENTS_PER_RECORD*Int32Array.BYTES_PER_ELEMENT},91957:(K,D,h)=>{h.d(D,{a:()=>R,m:()=>S});var M=h(53661);class R{constructor(r){if(this.next=null,!Array.isArray(r))return void(this.data=r);this.data=r[0];let E=this;for(let i=1;i<r.length;i++)E.next=new R([r[i]]),E=E.next}*values(){let r=this;for(;r;)yield r.data,r=r.next}forEach(r){let E=this;for(;E;)r(E.data),E=E.next}find(r){return r(this.data)?this:this.next?.find(r)}max(r,E=this){const i=r(this.data)>r(E.data)?this:E;return this.next?this.next.max(r,i):i}remove(r,E=null){return this===r?E?(E.next=this.next,E):this.next:this.next?.remove(r,this)??null}get last(){return this.next?this.next.last:this}}class S{constructor(r){this._head=null,(0,M.Wi)(r)||(this._head=new R(r))}get head(){return this._head}maxAvailableSpace(){if((0,M.Wi)(this._head))return 0;const r=this._head.max(E=>E.end-E.start);return r.data.end-r.data.start}firstFit(r){if((0,M.Wi)(this._head))return null;let E=null,i=this._head;for(;i;){const _=i.data.end-i.data.start;if(_===r)return E?E.next=i.next:this._head=i.next,i.data.start;if(_>r){const a=i.data.start;return i.data.start+=r,a}E=i,i=i.next}return null}free(r,E){const i=r+E;if((0,M.Wi)(this._head)){const b=new R({start:r,end:i});return void(this._head=b)}if(i<=this._head.data.start){if(i===this._head.data.start)return void(this._head.data.start-=E);const b=new R({start:r,end:i});return b.next=this._head,void(this._head=b)}let _=this._head,a=_.next;for(;a;){if(a.data.start>=i){if(_.data.end===r)return _.data.end+=E,_.data.end===a.data.start?(_.data.end+=a.data.end-a.data.start,void(_.next=a.next)):void 0;if(a.data.start===i)return void(a.data.start-=E);const b=new R({start:r,end:i});return b.next=_.next,void(_.next=b)}_=a,a=a.next}if(r===_.data.end)return void(_.data.end+=E);const g=new R({start:r,end:i});_.next=g}}},13458:(K,D,h)=>{h.d(D,{J:()=>R,g:()=>M});const M=(S,l)=>S&&((...r)=>l.warn("DEBUG:",...r))||(()=>null),R=!1},91661:(K,D,h)=>{h.r(D),h.d(D,{default:()=>ct});var M=h(71670),R=h(18100),S=h(67087),l=h(53661),r=h(30801),g=(h(28191),h(83382),h(19420),h(32995),h(20891)),b=h(6848),P=h(30248),O=h(80309),I=h(20753),W=h(52300),y=h(6833);const d=4294967296;class s{constructor(t){this._savedCursor=null,this._savedOffset=null,this._head=t,this._cursor=t}static from(t){const e=o.from(new Float32Array(t));return new s(e)}get id(){return this._cursor.id}get baseZoom(){return this._cursor.baseZoom}get anchorX(){return this._cursor.anchorX}get anchorY(){return this._cursor.anchorY}get directionX(){return this._cursor.directionX}get directionY(){return this._cursor.directionY}get size(){return this._cursor.size}get materialKey(){return this._cursor.materialKey}get boundsCount(){return this._cursor.boundsCount}computedMinZoom(){return this._cursor.computedMinZoom()}setComputedMinZoom(t){return this._cursor.setComputedMinZoom(t)}boundsComputedAnchorX(t){return this._cursor.boundsComputedAnchorX(t)}boundsComputedAnchorY(t){return this._cursor.boundsComputedAnchorY(t)}setBoundsComputedAnchorX(t,e){return this._cursor.setBoundsComputedAnchorX(t,e)}setBoundsComputedAnchorY(t,e){return this._cursor.setBoundsComputedAnchorY(t,e)}boundsX(t){return this._cursor.boundsX(t)}boundsY(t){return this._cursor.boundsY(t)}boundsWidth(t){return this._cursor.boundsWidth(t)}boundsHeight(t){return this._cursor.boundsHeight(t)}link(t){if((0,l.pC)(t._head))return this._cursor.link(t._head)}getCursor(){return this.copy()}copy(){const t=new s(this._head?.copy());if(!t._head)return t;let e=t._head,n=t._head._link;for(;n;)e._link=n.copy(),e=n,n=e._link;return t}peekId(){return this._cursor.peekId()??this._cursor._link.peekId()}nextId(){const t=this.id;for(;t===this.id;)if(!this.next())return!1;return!0}save(){this._savedCursor=this._cursor,this._savedOffset=this._cursor._offset}restore(){this._savedCursor&&(this._cursor=this._savedCursor),null!=this._savedOffset&&(this._cursor._offset=this._savedOffset)}next(){if(!this._cursor)return!1;if(!this._cursor.next()){if(!this._cursor._link)return!1;this._cursor=this._cursor._link,this._cursor._offset=0}return!0}lookup(t){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(t);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}delete(t){let e=this._head,n=null;for(;e;){if(e.delete(t))return e.isEmpty()&&(0,l.pC)(n)&&(n._link=e._link),!0;n=e,e=e._link}return!1}}class o{constructor(t){this._offset=-1,this._link=null,this._count=0,this._deletedCount=0,this._offsets={instance:null},this._buffer=t}static from(t){return new o(new Float32Array(t))}isEmpty(){return this._deletedCount===this.count}get count(){return this._count||(this._count=this._computeCount()),this._count}get id(){return this._buffer[this._offset+0]}set id(t){this._buffer[this._offset+0]=t}get baseZoom(){return this._buffer[this._offset+1]}get anchorX(){return this._buffer[this._offset+2]}get anchorY(){return this._buffer[this._offset+3]}get directionX(){return this._buffer[this._offset+4]}get directionY(){return this._buffer[this._offset+5]}get size(){return this._buffer[this._offset+6]}get materialKey(){return this._buffer[this._offset+7]}computedMinZoom(){return this._buffer[this._offset+8]}setComputedMinZoom(t){this._buffer[this._offset+8]=t}get boundsCount(){return this._buffer[this._offset+9]}boundsComputedAnchorX(t){return this._buffer[this._offset+10+6*t+0]}boundsComputedAnchorY(t){return this._buffer[this._offset+10+6*t+1]}setBoundsComputedAnchorX(t,e){this._buffer[this._offset+10+6*t+0]=e}setBoundsComputedAnchorY(t,e){this._buffer[this._offset+10+6*t+1]=e}boundsX(t){return this._buffer[this._offset+10+6*t+2]}boundsY(t){return this._buffer[this._offset+10+6*t+3]}boundsWidth(t){return this._buffer[this._offset+10+6*t+4]}boundsHeight(t){return this._buffer[this._offset+10+6*t+5]}link(t){let e=this;for(;e._link;)e=e._link;e._link=t}getCursor(){return this.copy()}copy(){const t=new o(this._buffer);return t._link=this._link,t._offset=this._offset,t._deletedCount=this._deletedCount,t._offsets=this._offsets,t._count=this._count,t}peekId(){const t=this._offset+10+6*this.boundsCount+0;return t>=this._buffer.length?0:this._buffer[t]}next(){let t=0;for(;this._offset<this._buffer.length&&t++<100&&(-1===this._offset?this._offset=0:this._offset+=10+6*this.boundsCount,this.id===d););return this.id!==d&&this._offset<this._buffer.length}delete(t){const e=this._offset,n=this.lookup(t);if(n)for(this.id=4294967295,++this._deletedCount;this.next()&&this.id===t;)this.id=4294967295,++this._deletedCount;return this._offset=e,n}lookup(t){const e=this._offset;if((0,l.Wi)(this._offsets.instance)){this._offsets.instance=new Map;const n=this.copy();n._offset=-1;let u=0;for(;n.next();)n.id!==u&&(this._offsets.instance.set(n.id,n._offset),u=n.id)}return!!this._offsets.instance.has(t)&&(this._offset=this._offsets.instance.get(t),this.id!==d||(this._offset=e,!1))}_computeCount(){const t=this._offset;let e=0;for(this._offset=-1;this.next();)e++;return this._offset=t,e}}var c=h(91957);class p{constructor(t,e,n,u,f){this.target=t,this.geometryType=e,this.materialKey=n,this.indexFrom=u,this.indexCount=f}get indexEnd(){return this.indexFrom+this.indexCount}extend(t){this.indexCount+=t}}class x{constructor(t,e){this.geometryType=0,this._target=t,this.geometryType=e}static from(t,e,n,u){const f=new x(t,e);if((0,l.pC)(u))for(const v of u)n.seekIndex(v),f.addRecord(n);else for(;n.next();)f.addRecord(n);return f}addRecord(t){const e=this._target,n=this.geometryType,u=t.materialKey;let f=t.indexFrom,v=t.indexCount;if(v||(f=t.vertexFrom,v=t.vertexCount),(0,l.Wi)(this._head)){const k=new p(e,n,u,f,v);return void(this._head=new c.a(k))}let z=null,A=this._head;for(;A;){if(f<A.data.indexFrom)return this._insert(u,f,v,z,A);z=A,A=A.next}this._insert(u,f,v,z,null)}forEach(t){(0,l.pC)(this._head)&&this._head.forEach(t)}*infos(){if((0,l.pC)(this._head))for(const t of this._head.values())yield t}_insert(t,e,n,u,f){if((0,l.Wi)(u)&&(0,l.Wi)(f)){const v=new p(this._target,this.geometryType,t,e,n);this._head=new c.a(v)}return(0,l.Wi)(u)&&(0,l.pC)(f)?this._insertAtHead(t,e,n,f):(0,l.pC)(u)&&(0,l.Wi)(f)?this._insertAtEnd(t,e,n,u):(0,l.pC)(u)&&(0,l.pC)(f)?this._insertAtMiddle(t,e,n,u,f):void 0}_insertAtHead(t,e,n,u){if(t===u.data.materialKey&&e+n===u.data.indexFrom)u.data.indexFrom=e,u.data.indexCount+=n;else{const v=new p(this._target,this.geometryType,t,e,n);this._head=new c.a(v),this._head.next=u}}_insertAtEnd(t,e,n,u){if(u.data.materialKey===t&&u.data.indexEnd===e)u.data.indexCount+=n;else{const f=new p(this._target,this.geometryType,t,e,n),v=new c.a(f);u.next=v}}_insertAtMiddle(t,e,n,u,f){const v=e+n;if(u.data.materialKey===t&&u.data.indexEnd===e)u.data.indexCount+=n,u.data.materialKey===f.data.materialKey&&u.data.indexEnd===f.data.indexFrom&&(u.data.indexCount+=f.data.indexCount,u.next=f.next);else if(t===f.data.materialKey&&v===f.data.indexFrom)f.data.indexFrom=e,f.data.indexCount+=n;else{const B=new p(this._target,this.geometryType,t,e,n),L=new c.a(B);u.next=L,L.next=f}}}var w=h(20533),T=h(10615),U=h(69923);class Y{constructor(t,e,n,u){const f=w.g.create(e*n*Uint32Array.BYTES_PER_ELEMENT,u);this.size=e,this.strideInt=n,this.bufferType=t,this.dirty={start:1/0,end:0},this._gpu=null,this._cpu=f,this.clear()}get elementSize(){return this._cpu.length/this.strideInt}get invalidated(){return this.bufferSize>0&&!this._gpu}get invalidatedComputeBuffer(){return this.bufferSize>0&&!this._gpuComputeTriangles}invalidate(){this._invalidateTriangleBuffer(),(0,l.yw)(this._gpu,t=>t.dispose()),this._gpu=null}_invalidateTriangleBuffer(){(0,l.yw)(this._gpuComputeTriangles,t=>t.dispose()),this._gpuComputeTriangles=null}destroy(){(0,l.yw)(this._gpu,t=>t.dispose()),(0,l.yw)(this._gpuComputeTriangles,t=>t.dispose()),(0,l.yw)(this._cpu,t=>t.destroy()),(0,l.yw)(this._cpu2,t=>t.destroy())}clear(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new c.m({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0}ensure(t){if(!(this.maxAvailableSpace()>=t)&&t*this.strideInt>this._cpu.length-this.fillPointer){this.invalidate();const e=this._cpu.length/this.strideInt,n=Math.round(1.25*(e+t));this._cpu.expand(n*this.strideInt*Uint32Array.BYTES_PER_ELEMENT),this.freeList.free(e,n-e)}}set(t,e){this._cpu.array[t]!==e&&(this._cpu.array[t]=e,this.dirty.start=Math.min(t,this.dirty.start),this.dirty.end=Math.max(t,this.dirty.end))}getGPUBuffer(t,e=!1){if(!this.bufferSize)return null;if(e){if("index"!==this.bufferType)throw new Error("Tired to get triangle buffer, but target is not an index buffer");return(0,l.Wi)(this._gpuComputeTriangles)&&(this._gpuComputeTriangles=this._createComputeBuffer(t)),this._gpuComputeTriangles}return(0,l.Wi)(this._gpu)&&(this._gpu=this._createBuffer(t)),this._gpu}getCPUBuffer(){if(!this._cpu2){const t=this._cpu.slice();this._cpu2=t}return this._cpu2.length!==this._cpu.length&&this._cpu2.expand(this._cpu.length*this._cpu.array.BYTES_PER_ELEMENT),this._cpu2.set(this._cpu),this._cpu2}get bufferSize(){return this._cpu.length/this.strideInt}maxAvailableSpace(){return this.freeList.maxAvailableSpace()}insert(t,e,n,u){const f=n*this.strideInt;if(!f)return 0;const v=e*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,B=new Uint32Array(t,v,f),L=(0,l.s3)(this.freeList.firstFit(n),"First fit region must be defined")*this.strideInt,z=f,A=L/this.strideInt-e;if(0!==u)for(let k=0;k<B.length;k++)B[k]+=u;return this._cpu.array.set(B,L),this.dirty.start=Math.min(this.dirty.start,L),this.dirty.end=Math.max(this.dirty.end,L+z),this.fillPointer=Math.max(this.fillPointer,L+z),A}free(t,e,n){const u=t*this.strideInt,f=(t+e)*this.strideInt;if(!0===n)for(let v=t;v!==t+e;v++)this._cpu.array[v*this.strideInt]=2147450879;this.dirty.start=Math.min(this.dirty.start,u),this.dirty.end=Math.max(this.dirty.end,f),this.freeList.free(t,e)}upload(){if(this.dirty.end){if(this._invalidateTriangleBuffer(),(0,l.Wi)(this._gpu))return this.dirty.start=1/0,void(this.dirty.end=0);this._gpu.setSubData(this._cpu.array,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}_createBuffer(t){const e=U.l1.DYNAMIC_DRAW;return"index"===this.bufferType?T.f.createIndex(t,e,this._cpu.array):T.f.createVertex(t,e,this._cpu.array)}_createComputeBuffer(t){const e=U.l1.DYNAMIC_DRAW,n=new Uint32Array(this.fillPointer/3);for(let u=0;u<this.fillPointer;u+=3)n[u/3]=this._cpu.array[u];return T.f.createIndex(t,e,n)}}var G=h(46461),$=h(19955);class q{constructor(t,e){this._vaos=new Map,this._indicesInvalid=!1,this.geometryType=t,this._stage=e}destroy(){for(const[t,e]of this._vaos)(0,l.pC)(e)&&e.dispose(!1);this._indexBuffer=(0,l.SC)(this._indexBuffer),this._vertexBuffer=(0,l.SC)(this._vertexBuffer)}insert(t,e,n){if(!t.records.byteLength)return;const u=t.stride;if(this._vertexBuffer&&this._indexBuffer){const v=t.vertices.byteLength/u;this._indexBuffer.ensure(t.indices.byteLength/4),this._vertexBuffer.ensure(v);const{vertices:B,indices:L}=t,z=G.$.from(t.records),A=this._vertexBuffer.insert(B,0,B.byteLength/u,0),k=this._indexBuffer.insert(L,0,L.byteLength/4,A);if(z.forEach(N=>{N.indexFrom+=k,N.vertexFrom+=A}),(0,l.s3)(this._records,"Expected records to be defined").link(z),e)this._indicesInvalid=!0;else if(this._displayList){const N=z.getCursor();for(;N.next();)this._displayList.addRecord(N)}}else{const f=t.indices.byteLength/4,v=t.vertices.byteLength/u,B=u/Uint32Array.BYTES_PER_ELEMENT,L=this._stage.bufferPool;this._records=G.$.from(t.records),this._indexBuffer=new Y("index",f,1,L),this._vertexBuffer=new Y("vertex",v,B,L),this._indexBuffer.insert(t.indices,0,t.indices.byteLength/4,0),this._vertexBuffer.insert(t.vertices,0,t.vertices.byteLength/u,0),e&&(this._indicesInvalid=!0)}}remove(t){if(!(0,l.Wi)(this._records))for(const e of t){const n=this._records.getCursor();if(!n.lookup(e))continue;const u=n.indexFrom,f=n.vertexFrom;let v=n.indexCount,B=n.vertexCount;for(;n.next()&&n.id===e;)v+=n.indexCount,B+=n.vertexCount;this._indexBuffer.free(u,v),this._vertexBuffer.free(f,B,!0),this._records.delete(e)}}getVAO(t,e,n,u){if(!this._vertexBuffer||!this._indexBuffer||(0,l.Wi)(this._records)||!this._vertexBuffer.bufferSize)return null;const f=u?1:0;let v=this._vaos.get(f);(this._vertexBuffer.invalidated||this._indexBuffer.invalidated||u&&this._indexBuffer.invalidatedComputeBuffer)&&((0,l.yw)(v,z=>z.dispose(!1)),v=null),this._vertexBuffer.upload(),this._indexBuffer.upload();const B=this._indexBuffer.getGPUBuffer(t,1===f),L=this._vertexBuffer.getGPUBuffer(t);return v||(v=new $.U(t,n,e,{geometry:L},B),this._vaos.set(f,v)),v}forEachCommand(t){if(!(0,l.Wi)(this._records)){if(this._sortIndices(this._records),!this._displayList){const e=this._cursorIndexOrder;this._displayList=x.from(this,this.geometryType,this._records.getCursor(),e)}this._displayList.forEach(t)}}_sortIndices(t){const e=!!this._indexBuffer.bufferSize;if(!this._indicesInvalid)return;this._indicesInvalid=!1;let n=0;const u=t.getCursor(),f=[],v=[],B=[];for(;u.next();)v.push(u.index),B.push(u.sortKey),f.push(u.id);v.sort((A,k)=>{const N=B[k],Z=B[A];return Z===N?f[k]-f[A]:N-Z});const L=t.getCursor(),z=e?this._indexBuffer.getCPUBuffer():this._vertexBuffer.getCPUBuffer();for(const A of v){if(!L.seekIndex(A))throw new Error("Expected to find index");if(e){const{indexFrom:k,indexCount:N}=L;L.indexFrom=n;for(let Z=0;Z<N;Z++)this._indexBuffer.set(n++,z.array[k+Z])}else{const{vertexFrom:k,vertexCount:N}=L,Z=this._vertexBuffer.strideInt,it=k*Z,ft=it+N*Z;L.vertexFrom=n/Z;for(let et=it;et<ft;et++)this._vertexBuffer.set(n++,z.array[et])}}this._cursorIndexOrder=v,this._displayList=null}}let nt=0;class at extends y.o{constructor(t,e,n,u,f,v){super(t,e,n,u),this.instanceId=nt++,this.patchCount=0,this._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1},this._patches=new P.Z(100),this._bufferPatches=new P.Z(100),this._lastCommitTime=0,this.transforms.labelMat2d=(0,O.c)(),this._store=f,this._requestLabelUpdate=v}destroy(){super.destroy(),this._renderState.current.geometry.forEach(t=>t.destroy()),(0,l.pC)(this._renderState.next)&&this._renderState.next.geometry.forEach(t=>t.destroy()),this._renderState.current=null,this._renderState.next=null}get labelMetrics(){return this._renderState.current.metrics}get hasData(){return!!this._renderState.current.geometry.size}getGeometry(t){return this._renderState.current.geometry.get(t)}patch(t,e){this.patchCount++,t.clear&&this._patches.size>=50&&this._dropPatches();const n=t;e&&n.addOrUpdate&&this.key.id!==n.addOrUpdate.tileKeyOrigin?this._bufferPatches.enqueue(n):(n.sort=n.sort&&!e,this._patches.enqueue(n)),this.requestRender()}commit(t){if(this._lastCommitTime!==t.time){this._lastCommitTime=t.time;for(let e=0;e<4;e++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}}lock(){this._renderState.locked=!0}unlock(){this._renderState.locked=!1,this._flushUpdates(),this._swap()}_swapRenderStates(){if(this._renderState.next){if(this._renderState.locked)return this._renderState.swap=!0,void this.requestRender();this._renderState.swap=!0,this._swap()}}_swap(){this._renderState.swap&&(this._renderState.swap=!1,(0,l.pC)(this._renderState.next)&&(this._renderState.current.geometry.forEach(t=>t.destroy()),this._renderState.current=this._renderState.next,this._renderState.next=null,this._requestLabelUpdate()))}_flushUpdates(){let t=this._patches.maxSize;for(;this._patches.size&&t--;)this._updateMesh(),this._swap()}_updateBufferMesh(){const t=this._bufferPatches.peek();if(!(0,l.pC)(t)||!t.clear||null===this._renderState.next)for(;this._bufferPatches.size;){const e=this._bufferPatches.dequeue();(0,l.pC)(e)&&this._patchBuffer(e)}}_updateMesh(){const t=this._patches.dequeue();if((0,l.pC)(t)){if((0,S.Z)("esri-2d-update-debug")){const e=t,n=e.addOrUpdate?.tileKeyOrigin,u=this.key.id===n?"SELF":n;let f="";for(let v=0;v<5;v++)f+=e.addOrUpdate?.data[v]?.records?.byteLength?1:0;console.debug(this.key.id,"FeatureTile:patch",`[clear: ${e.clear} origin: ${u}, end:${e.end} data:${f}]`)}!0===t.clear&&((0,l.pC)(this._renderState.next)&&(this._renderState.next.geometry.forEach(e=>e.destroy()),this._renderState.next=null),this._renderState.next={geometry:new Map,metrics:null},(0,S.Z)("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Creating new renderState")),this.requestRender(),this._patch(t),t.end&&((0,S.Z)("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Encountered end message"),this.ready(),this._swapRenderStates())}}_patch(t){(0,W.Z_)(e=>{this._remove(e,t.remove),this._insert(e,t,!1)})}_patchBuffer(t){(0,W.Z_)(e=>{this._insert(e,t,!0)})}_insert(t,e,n){try{const u=(0,l.Pt)(this._renderState.next,this._renderState.current),f=e.addOrUpdate?.data[t],v=u.geometry;if((0,l.Wi)(f))return;v.has(t)||((0,S.Z)("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Creating geometry buffer ${t}`),v.set(t,new q(t,this.stage))),(0,S.Z)("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Inserting into ${t}, version=${e.addOrUpdate?.version} stride=${f.stride}`),v.get(t).insert(f,e.sort,n),t===I.LW.LABEL&&this._insertLabelMetrics(e.type,f.metrics,e.clear)}catch{}}_insertLabelMetrics(t,e,n){const u=(0,l.Pt)(this._renderState.next,this._renderState.current);if((0,l.Wi)(e))return;const f=s.from(e);if((0,l.Wi)(u.metrics))u.metrics=f;else{if("update"===t){const v=f.getCursor();for(;v.next();)u.metrics.delete(v.id)}u.metrics.link(f)}}_remove(t,e){const n=(0,l.Pt)(this._renderState.next,this._renderState.current).geometry.get(t);e&&e.length&&n&&(n.remove(e),this._removeLabelMetrics(e))}_removeLabelMetrics(t){const{metrics:e}=(0,l.Pt)(this._renderState.next,this._renderState.current);if(!(0,l.Wi)(e)&&t.length)for(const n of t)for(;e.delete(n););}_dropPatches(){const t=new Array;let e=!1;for(;this._patches.size;){const n=this._patches.dequeue();if((0,l.Wi)(n))break;if(n.clear){if(e)break;e=!0}t.push(n)}this._patches.clear(),t.forEach(n=>this._patches.enqueue(n))}}var ot=h(17235),ht=h(43363),ut=h(99890),F=h(23529),dt=h(99704);const lt=(0,S.Z)("featurelayer-order-by-server-enabled");class _t extends dt.T{constructor(t,e,n,u){super(t),this._hitTestsRequests=[],this._layer=n,this._layerView=e,this._onUpdate=u}renderChildren(t){this.attributeView.update(),this.hasAnimation&&t.painter.effects.integrate.draw(t,t.attributeView),super.renderChildren(t)}hasEmptyAttributeView(){return this.attributeView.isEmpty()}isUpdating(){return this.attributeView.isUpdating()}hitTest(t){let e=this._hitTestsRequests.find(({x:u,y:f})=>u===t.x&&f===t.y);const n=(0,r.hh)();return e?e.resolvers.push(n):(e={x:t.x,y:t.y,resolvers:[n]},this._hitTestsRequests.push(e)),this.requestRender(),n.promise}onTileData(t,e){const n=lt&&"orderBy"in this._layer&&this._layer.orderBy;t.patch(e,!!n&&this._layerView.orderByFields===(n&&n?.length&&!n[0].valueExpression&&n[0].field)),this.contains(t)||this.addChild(t),this.requestRender()}onTileError(t){this.contains(t)||this.addChild(t)}updateTransitionProperties(t,e){super.updateTransitionProperties(t,e),this._layerView.featureEffectView.transitionStep(t,e),this._layerView.featureEffectView.transitioning&&this.requestRender()}doRender(t){const{minScale:e,maxScale:n}=this._layer.effectiveScaleRange,u=t.state.scale;u<=(e||1/0)&&u>=n&&super.doRender(t)}afterRender(t){super.afterRender(t),this._hitTestsRequests.length&&this.requestRender()}onAttributeStoreUpdate(){this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._onUpdate()}get hasAnimation(){return this.hasLabels}setStencilReference(t){const{rendererSchema:e}=t.rendererInfo;if("dot-density"===e?.type&&e?.dotSize>1||"heatmap"===e?.type)for(const u of this.children)u.stencilRef=u.key.level+1;else super.setStencilReference(t)}get hasLabels(){if("sublayers"in this._layer)return this._layer.sublayers.some(n=>!!n.labelingInfo?.length&&n.labelsVisible);const t=this._layer.featureReduction;return this._layer.labelingInfo&&this._layer.labelingInfo.length&&this._layer.labelsVisible||!!(t&&"labelingInfo"in t&&t.labelsVisible&&t.labelingInfo&&t.labelingInfo.length)}prepareRenderPasses(t){const e=t.registerRenderPass({name:"label",brushes:[F.U.label],target:()=>this.hasLabels?this.children:null,drawPhase:I.jx.LABEL|I.jx.LABEL_ALPHA}),n=t.registerRenderPass({name:"geometry",brushes:[F.U.fill,F.U.dotDensity,F.U.line,F.U.marker,F.U.heatmap,F.U.pieChart,F.U.text],target:()=>this.children,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:t.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:t.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:t.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]}),u=t.registerRenderPass({name:"highlight",brushes:[F.U.fill,F.U.dotDensity,F.U.line,F.U.marker,F.U.pieChart,F.U.text],target:()=>this.children,drawPhase:I.jx.HIGHLIGHT,enableDefaultDraw:()=>!1,effects:[{apply:t.effects.highlight,enable:()=>!!this._layerView.hasHighlight()}]});return[...super.prepareRenderPasses(t),n,u,e]}}let tt=class extends ht.Z{constructor(){super(...arguments),this.type="symbol"}install(C){const e=new _t(this.tileInfoView,this.layerView,this.layer,()=>this.notifyChange("updating"));this.featuresView=e,C.addChild(e)}uninstall(C){C.removeChild(this.featuresView),this.featuresView=(0,l.SC)(this.featuresView)}fetchResource(C,t){const{url:e}=C,n=this.featuresView.stage;try{return n.resourceManager.fetchResource(e,{signal:t.signal})}catch(u){return(0,r.D_)(u)?Promise.resolve({width:0,height:0}):Promise.reject(u)}}isUpdating(){const C=super.isUpdating(),t=!this.featuresView||this.featuresView.isUpdating(),e=this.featuresView?.hasEmptyAttributeView(),n=C||t||C&&e;return(0,S.Z)("esri-2d-log-updating")&&console.log(`Updating SymbolTileRenderer ${n}\n  -> updatingTiles ${C}\n  -> hasFeaturesView ${!!this.featuresView}\n  -> updatingFeaturesView ${t}`),n}hitTest(C){return this.featuresView.hitTest(C)}supportsRenderer(C){return null!=C&&["simple","class-breaks","unique-value","dot-density","dictionary","heatmap","pie-chart"].includes(C.type)}onConfigUpdate(C){let t=null;if(C&&"visualVariables"in C){const e=((0,ot.aR)(C).visualVariables||[]).map(n=>{const u=n.clone();return"normalizationField"in n&&(u.normalizationField=null),n.valueExpression&&"$view.scale"!==n.valueExpression&&(u.valueExpression=null,u.field="nop"),u});t=(0,ut.I)(e)}this.featuresView.setRendererInfo(C,t,this.layerView.featureEffect)}onTileData(C){const t=this.tiles.get(C.tileKey);t&&C.data&&this.featuresView.onTileData(t,C.data),this.layerView.view.labelManager.requestUpdate()}onTileError(C){const t=this.tiles.get(C.tileKey);t&&this.featuresView.onTileError(t)}forceAttributeTextureUpload(){this.featuresView.attributeView.forceTextureUpload()}lockGPUUploads(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach(C=>C.lock())}unlockGPUUploads(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach(C=>C.unlock())}getMaterialItems(C){var t=this;return(0,M.Z)(function*(){return t.featuresView.getMaterialItems(C)})()}invalidateLabels(){this.featuresView.hasLabels&&this.layerView.view.labelManager.requestUpdate()}createTile(C){const t=this.tileInfoView.getTileBounds((0,b.Ue)(),C),n=this.tileInfoView.getTileResolution(C.level);return new at(C,n,t[0],t[3],this.featuresView.attributeView,()=>this.layerView.view.labelManager.requestUpdate())}disposeTile(C){this.featuresView.removeChild(C),C.destroy(),this.layerView.view.labelManager.requestUpdate()}};tt=(0,R._)([(0,g.j)("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],tt);const ct=tt},99890:(K,D,h)=>{h.d(D,{I:()=>P,qc:()=>i});var M=h(53661),R=h(55798),S=h(9203),l=h(80696),r=h(20753),E=h(75683);function i(y,m){if(!y||!m)return y;switch(m){case"radius":case"distance":return 2*y;case"diameter":case"width":return y;case"area":return Math.sqrt(y)}return y}function a(y){return(y??[]).map(m=>function _(y){return{value:y.value,size:(0,R.t_)(y.size)}}(m))}function g(y){return"string"==typeof y||"number"==typeof y?(0,R.t_)(y):{type:"size",expression:y.expression,stops:a(y.stops)}}const b=y=>{const m=[],d=[],s=a(y),o=s.length;for(let c=0;c<6;c++){const p=s[Math.min(c,o-1)];m.push(p.value),d.push(null==p.size?l.AI:(0,R.F2)(p.size))}return{values:new Float32Array(m),sizes:new Float32Array(d)}};function P(y){const m=y&&y.length>0?{}:null,d=m?{}:null;if(!m||!d)return{vvFields:m,vvRanges:d};for(const s of y)if(s.field&&(m[s.type]=s.field),"size"===s.type){d.size||(d.size={});const o=s;switch((0,E.a)(o)){case r.X.SIZE_MINMAX_VALUE:d.size.minMaxValue={minDataValue:o.minDataValue,maxDataValue:o.maxDataValue,minSize:g(o.minSize),maxSize:g(o.maxSize)};break;case r.X.SIZE_SCALE_STOPS:d.size.scaleStops={stops:a(o.stops)};break;case r.X.SIZE_FIELD_STOPS:if(o.levels){const c={};for(const p in o.levels)c[p]=b(o.levels[p]);d.size.fieldStops={type:"level-dependent",levels:c}}else d.size.fieldStops={type:"static",...b(o.stops)};break;case r.X.SIZE_UNIT_VALUE:d.size.unitValue={unit:o.valueUnit,valueRepresentation:o.valueRepresentation??void 0}}}else"color"===s.type?d.color=W(s):"opacity"===s.type?d.opacity=O(s):"rotation"===s.type&&(d.rotation={type:s.rotationType});return{vvFields:m,vvRanges:d}}function O(y){const m={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof y.field){if(!y.stops)return null;{if(y.stops.length>8)return null;const d=y.stops;for(let s=0;s<8;++s){const o=d[Math.min(s,d.length-1)];m.values[s]=o.value,m.opacities[s]=o.opacity}}}else{if(!(y.stops&&y.stops.length>=0))return null;{const d=y.stops&&y.stops.length>=0?y.stops[0].opacity:0;for(let s=0;s<8;s++)m.values[s]=1/0,m.opacities[s]=d}}return m}function I(y,m,d){y[4*m+0]=d.r/255,y[4*m+1]=d.g/255,y[4*m+2]=d.b/255,y[4*m+3]=d.a}function W(y){if((0,M.Wi)(y)||y.normalizationField)return null;const m={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};if("string"==typeof y.field){if(!y.stops)return null;{if(y.stops.length>8)return null;m.field=y.field;const d=y.stops;for(let s=0;s<8;++s){const o=d[Math.min(s,d.length-1)];m.values[s]=o.value,I(m.colors,s,o.color)}}}else{if(!(y.stops&&y.stops.length>=0))return null;{const d=y.stops&&y.stops.length>=0&&y.stops[0].color;for(let s=0;s<8;s++)m.values[s]=1/0,I(m.colors,s,d)}}for(let d=0;d<32;d+=4)(0,S.pr)(m.colors,d,!0);return m}}}]);
//# sourceMappingURL=1661.7dea8679dfcd0497.js.map